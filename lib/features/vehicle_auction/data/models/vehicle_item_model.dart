import 'package:cloud_firestore/cloud_firestore.dart';
import '../../domain/entities/vehicle_item.dart';

/// Vehicle item model with Firestore serialization
class VehicleItemModel extends VehicleItem {
  const VehicleItemModel({
    required super.id,
    required super.auctionId,
    required super.contractNo,
    required super.rcNo,
    required super.make,
    required super.model,
    super.chassisDesc,
    required super.engineNo,
    required super.chassisNo,
    required super.yom,
    required super.fuelType,
    super.ppt,
    required super.yardName,
    required super.yardCity,
    required super.yardState,
    required super.basePrice,
    required super.bidIncrement,
    super.multipleAmount,
    super.currentBid,
    super.winnerId,
    super.winningBid,
    super.images,
    super.vahanUrl,
    super.contactPerson,
    super.contactNumber,
    super.remark,
    super.rcAvailable,
    super.repoDate,
    super.startDate,
    super.endDate,
    super.status,
    super.isActive,
    required super.createdAt,
    required super.updatedAt,
  });

  /// Create VehicleItemModel from Firestore document
  factory VehicleItemModel.fromFirestore(DocumentSnapshot doc) {
    final data = doc.data() as Map<String, dynamic>;
    return VehicleItemModel(
      id: doc.id,
      auctionId: data['auctionId'] ?? '',
      contractNo: data['contractNo'] ?? '',
      rcNo: data['rcNo'] ?? '',
      make: data['make'] ?? '',
      model: data['model'] ?? '',
      chassisDesc: data['chassisDesc'] ?? '',
      engineNo: data['engineNo'] ?? '',
      chassisNo: data['chassisNo'] ?? '',
      yom: data['yom'] ?? 0,
      fuelType: data['fuelType'] ?? '',
      ppt: data['ppt'] ?? '',
      yardName: data['yardName'] ?? '',
      yardCity: data['yardCity'] ?? '',
      yardState: data['yardState'] ?? '',
      basePrice: (data['basePrice'] ?? 0).toDouble(),
      bidIncrement: (data['bidIncrement'] ?? 0).toDouble(),
      multipleAmount: (data['multipleAmount'] ?? 0).toDouble(),
      currentBid: (data['currentBid'] ?? 0).toDouble(),
      winnerId: data['winnerId'],
      winningBid: data['winningBid']?.toDouble(),
      images: List<String>.from(data['images'] ?? []),
      vahanUrl: data['vahanUrl'],
      contactPerson: data['contactPerson'],
      contactNumber: data['contactNumber'],
      remark: data['remark'],
      rcAvailable: data['rcAvailable'] ?? false,
      repoDate: (data['repoDate'] as Timestamp?)?.toDate(),
      startDate: (data['startDate'] as Timestamp?)?.toDate(),
      endDate: (data['endDate'] as Timestamp?)?.toDate(),
      status: data['status'] ?? 'upcoming',
      isActive: data['isActive'] ?? true,
      createdAt: (data['createdAt'] as Timestamp?)?.toDate() ?? DateTime.now(),
      updatedAt: (data['updatedAt'] as Timestamp?)?.toDate() ?? DateTime.now(),
    );
  }

  /// Create VehicleItemModel from Map
  factory VehicleItemModel.fromMap(String id, Map<String, dynamic> data) {
    return VehicleItemModel(
      id: id,
      auctionId: data['auctionId'] ?? '',
      contractNo: data['contractNo'] ?? '',
      rcNo: data['rcNo'] ?? '',
      make: data['make'] ?? '',
      model: data['model'] ?? '',
      chassisDesc: data['chassisDesc'] ?? '',
      engineNo: data['engineNo'] ?? '',
      chassisNo: data['chassisNo'] ?? '',
      yom: data['yom'] ?? 0,
      fuelType: data['fuelType'] ?? '',
      ppt: data['ppt'] ?? '',
      yardName: data['yardName'] ?? '',
      yardCity: data['yardCity'] ?? '',
      yardState: data['yardState'] ?? '',
      basePrice: (data['basePrice'] ?? 0).toDouble(),
      bidIncrement: (data['bidIncrement'] ?? 0).toDouble(),
      multipleAmount: (data['multipleAmount'] ?? 0).toDouble(),
      currentBid: (data['currentBid'] ?? 0).toDouble(),
      winnerId: data['winnerId'],
      winningBid: data['winningBid']?.toDouble(),
      images: List<String>.from(data['images'] ?? []),
      vahanUrl: data['vahanUrl'],
      contactPerson: data['contactPerson'],
      contactNumber: data['contactNumber'],
      remark: data['remark'],
      rcAvailable: data['rcAvailable'] ?? false,
      repoDate: _parseDateTime(data['repoDate']),
      startDate: _parseDateTime(data['startDate']),
      endDate: _parseDateTime(data['endDate']),
      status: data['status'] ?? 'upcoming',
      isActive: data['isActive'] ?? true,
      createdAt: _parseDateTime(data['createdAt']) ?? DateTime.now(),
      updatedAt: _parseDateTime(data['updatedAt']) ?? DateTime.now(),
    );
  }

  /// Create VehicleItemModel from VehicleItem entity
  factory VehicleItemModel.fromEntity(VehicleItem vehicle) {
    return VehicleItemModel(
      id: vehicle.id,
      auctionId: vehicle.auctionId,
      contractNo: vehicle.contractNo,
      rcNo: vehicle.rcNo,
      make: vehicle.make,
      model: vehicle.model,
      chassisDesc: vehicle.chassisDesc,
      engineNo: vehicle.engineNo,
      chassisNo: vehicle.chassisNo,
      yom: vehicle.yom,
      fuelType: vehicle.fuelType,
      ppt: vehicle.ppt,
      yardName: vehicle.yardName,
      yardCity: vehicle.yardCity,
      yardState: vehicle.yardState,
      basePrice: vehicle.basePrice,
      bidIncrement: vehicle.bidIncrement,
      multipleAmount: vehicle.multipleAmount,
      currentBid: vehicle.currentBid,
      winnerId: vehicle.winnerId,
      winningBid: vehicle.winningBid,
      images: vehicle.images,
      vahanUrl: vehicle.vahanUrl,
      contactPerson: vehicle.contactPerson,
      contactNumber: vehicle.contactNumber,
      remark: vehicle.remark,
      rcAvailable: vehicle.rcAvailable,
      repoDate: vehicle.repoDate,
      startDate: vehicle.startDate,
      endDate: vehicle.endDate,
      status: vehicle.status,
      isActive: vehicle.isActive,
      createdAt: vehicle.createdAt,
      updatedAt: vehicle.updatedAt,
    );
  }

  /// Convert to Firestore map
  Map<String, dynamic> toFirestore() {
    return {
      'auctionId': auctionId,
      'contractNo': contractNo,
      'rcNo': rcNo,
      'make': make,
      'model': model,
      'chassisDesc': chassisDesc,
      'engineNo': engineNo,
      'chassisNo': chassisNo,
      'yom': yom,
      'fuelType': fuelType,
      'ppt': ppt,
      'yardName': yardName,
      'yardCity': yardCity,
      'yardState': yardState,
      'basePrice': basePrice,
      'bidIncrement': bidIncrement,
      'multipleAmount': multipleAmount,
      'currentBid': currentBid,
      'winnerId': winnerId,
      'winningBid': winningBid,
      'images': images,
      'vahanUrl': vahanUrl,
      'contactPerson': contactPerson,
      'contactNumber': contactNumber,
      'remark': remark,
      'rcAvailable': rcAvailable,
      'repoDate': repoDate != null ? Timestamp.fromDate(repoDate!) : null,
      'startDate': startDate != null ? Timestamp.fromDate(startDate!) : null,
      'endDate': endDate != null ? Timestamp.fromDate(endDate!) : null,
      'status': status,
      'isActive': isActive,
      'createdAt': Timestamp.fromDate(createdAt),
      'updatedAt': Timestamp.fromDate(updatedAt),
    };
  }

  /// Convert to Map for updates
  Map<String, dynamic> toUpdateMap() {
    return {
      'contractNo': contractNo,
      'rcNo': rcNo,
      'make': make,
      'model': model,
      'chassisDesc': chassisDesc,
      'engineNo': engineNo,
      'chassisNo': chassisNo,
      'yom': yom,
      'fuelType': fuelType,
      'ppt': ppt,
      'yardName': yardName,
      'yardCity': yardCity,
      'yardState': yardState,
      'basePrice': basePrice,
      'bidIncrement': bidIncrement,
      'multipleAmount': multipleAmount,
      'images': images,
      'vahanUrl': vahanUrl,
      'contactPerson': contactPerson,
      'contactNumber': contactNumber,
      'remark': remark,
      'rcAvailable': rcAvailable,
      'repoDate': repoDate != null ? Timestamp.fromDate(repoDate!) : null,
      'startDate': startDate != null ? Timestamp.fromDate(startDate!) : null,
      'endDate': endDate != null ? Timestamp.fromDate(endDate!) : null,
      'status': status,
      'isActive': isActive,
      'updatedAt': Timestamp.fromDate(DateTime.now()),
    };
  }

  static DateTime? _parseDateTime(dynamic value) {
    if (value == null) return null;
    if (value is Timestamp) return value.toDate();
    if (value is String) return DateTime.tryParse(value);
    return null;
  }
}
